<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; background: #2b2e38; color: #ddd; font-size: 13px; }
        
        /* HEADER */
        h3 { margin: 0 0 15px 0; color: white; text-transform: uppercase; border-bottom: 2px solid #66c0f4; padding-bottom: 8px; font-size: 14px; letter-spacing: 0.5px; }

        /* STATUS BOX */
        .status-box { background: #1f2129; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #66c0f4; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .stat-row:last-child { margin-bottom: 0; }
        .label { color: #888; font-size: 12px; }
        .value { font-weight: bold; color: white; text-align: right; }
        .highlight { color: #66c0f4; }
        .success { color: #4caf50; }

        /* SECTIONS */
        .section-box { margin-top: 15px; background: #23262e; padding: 10px; border-radius: 6px; border: 1px solid #3a3f4b; }
        .section-title { font-size: 11px; color: #aaa; text-transform: uppercase; display: block; margin-bottom: 8px; font-weight: bold; letter-spacing: 0.5px; border-bottom: 1px solid #333; padding-bottom: 4px; }

        /* CONTROLS */
        button { width: 100%; padding: 8px; margin-bottom: 8px; background: #3a3f4b; color: white; border: 1px solid #111; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; transition: background 0.2s; }
        button:hover { background: #4d5463; }
        button:active { transform: translateY(1px); }
        
        input[type="text"], select { width: 100%; box-sizing: border-box; background: #111; border: 1px solid #444; color: #ddd; padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 12px; }
        input[type="text"]:focus, select:focus { border-color: #66c0f4; outline: none; }

        /* SLIDER & TOGGLES */
        input[type=range] { width: 100%; cursor: pointer; margin: 5px 0; }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; font-size: 12px; }
        .theme-opt { display: flex; gap: 15px; margin-bottom: 8px; font-size: 12px; }
        .radio-label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        input[type="color"] { width: 100%; height: 25px; border: none; background: none; cursor: pointer; padding: 0; }

        /* UTILITY CLASSES */
        .hidden { display: none; }
        .danger-btn { background: #5c2b2b; border-color: #3e1b1b; }
        .danger-btn:hover { background: #a13636; }
        .secondary-btn { background: #2b2e38; color: #aaa; }
        .secondary-btn:hover { background: #3a3f4b; color: white; }

        /* FOOTER */
        .footer { margin-top: 25px; padding-top: 15px; border-top: 1px solid #333; text-align: center; font-size: 10px; color: #555; }
        .footer a { color: #66c0f4; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h3>Steam Achievement Tracker</h3>

    <!-- LIVE STATUS -->
    <div class="status-box">
        <div class="stat-row">
            <span class="label">STATUS</span>
            <span id="status-text">Connecting...</span>
        </div>
        <div class="stat-row">
            <span class="label">GAME</span>
            <span id="game-val" class="value">---</span>
        </div>
        <div class="stat-row">
            <span class="label">SESSION</span>
            <span class="value"><span id="timer-val" class="highlight">00:00</span> <span id="unlocks-val" class="success"></span></span>
        </div>
    </div>

    <!-- SETTINGS -->
    <div class="section-box">
        <span class="section-title">Settings</span>
        
        <!-- Volume -->
        <div style="display:flex; justify-content:space-between; font-size:11px; color:#bbb; margin-bottom:2px; margin-top:10px;">
            <span>Unlock Volume</span>
            <span id="vol-label">50%</span>
        </div>
        <input type="range" id="vol-slider" min="0" max="100" value="50" onchange="updateConfig()" oninput="document.getElementById('vol-label').innerText = this.value + '%'">
        
        <!-- Toggles -->
        <div class="toggle-row">
            <span>Play Sound</span>
            <input type="checkbox" id="chk-sound" onchange="updateConfig()">
        </div>
        <div class="toggle-row">
            <span>Show Standby Mode</span>
            <input type="checkbox" id="chk-standby" onchange="updateConfig()">
        </div>

        <!-- Theme -->
        <div style="margin-top:10px; border-top:1px solid #333; padding-top:8px;">
            <div class="theme-opt">
                <label class="radio-label">
                    <input type="radio" name="theme_mode" value="dynamic" onchange="updateConfig()" checked> Auto Color
                </label>
                <label class="radio-label">
                    <input type="radio" name="theme_mode" value="custom" onchange="updateConfig()"> Custom
                </label>
            </div>
            <div id="custom-color-box" class="hidden">
                <input type="color" id="custom-color" value="#66c0f4" onchange="updateConfig()">
            </div>
        </div>
        
        <button onclick="testAlert()" class="secondary-btn" style="margin-top:5px;">üîä Test Alert</button>
    </div>

    <!-- GAME TOOLS (Only visible when active) -->
    <div id="game-tools" class="hidden">
        <div class="section-box">
            <span class="section-title">Active Game Tools</span>
            
            <!-- Hunter Mode -->
            <label class="label" style="display:block; margin-bottom:4px;">Pin Target Achievement</label>
            <select id="lock-list" onchange="setPin()">
                <option value="">-- Select Target --</option>
            </select>
            <button onclick="clearPin()" class="secondary-btn" style="padding:4px; font-size:11px;">Unpin Target</button>

            <!-- Rename -->
            <label class="label" style="display:block; margin-top:10px; margin-bottom:4px;">Override Game Name</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="name-override" placeholder="Custom Title..." style="margin-bottom:0;">
                <button onclick="saveNameOverride()" style="width:auto; margin-bottom:0;">Save</button>
            </div>
        </div>
    </div>

    <!-- SYSTEM TOOLS -->
    <div class="section-box">
        <span class="section-title">System</span>
        <input type="text" id="manual-id" placeholder="Manual App ID (e.g. 1245620)">
        <button onclick="saveManualID()">Force Load ID</button>
        <button onclick="restartSession()">üîÑ Restart Session Timer</button>
        <button onclick="fullReset()" class="danger-btn">‚ö† Reset Account / Keys</button>
        <button onclick="shutdownApp()" class="danger-btn" style="background:#800000; margin-top: 5px;">‚ùå Quit Tracker</button>
    </div>

    <!-- FOOTER -->
    <div class="footer">
        v1.6 ‚Ä¢ Powered by <a href="https://linktr.ee/zakypew" target="_blank">ZakyPew</a>
    </div>

    <script>
        let currentAppID = null;
        let loadedLockedList = false;

        async function updateConfig() {
            const standby = document.getElementById('chk-standby').checked;
            const sound = document.getElementById('chk-sound').checked;
            const vol = document.getElementById('vol-slider').value;
            const themeMode = document.querySelector('input[name="theme_mode"]:checked').value;
            const color = document.getElementById('custom-color').value;
            
            document.getElementById('custom-color-box').style.display = (themeMode === 'custom') ? 'block' : 'none';

            await fetch('http://localhost:5000/settings', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    show_standby: standby, 
                    play_sound: sound,
                    volume: parseInt(vol),
                    theme_mode: themeMode,
                    custom_color: color
                })
            });
        }

        async function testAlert() {
            await fetch('http://localhost:5000/trigger_test', { method: 'POST' });
        }

        async function saveNameOverride() {
            const newName = document.getElementById('name-override').value;
            if (currentAppID) {
                await fetch('http://localhost:5000/set_name_override', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({appid: currentAppID, name: newName})
                });
                refresh();
            }
        }

        async function saveManualID() {
            const mid = document.getElementById('manual-id').value;
            await fetch('http://localhost:5000/settings', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ manual_id: mid })
            });
            alert(mid ? "Forcing Game ID: " + mid : "Resumed Auto-Detection");
            location.reload();
        }

        async function setPin() {
            const achId = document.getElementById('lock-list').value;
            if (currentAppID) {
                await fetch('http://localhost:5000/set_pin', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({appid: currentAppID, ach_id: achId})
                });
            }
        }

        async function clearPin() {
            document.getElementById('lock-list').value = "";
            setPin();
        }

        async function restartSession() { await fetch('http://localhost:5000/restart_session', { method: 'POST' }); }
        
        async function fullReset() { 
            if(confirm("Disconnect accounts and reset all keys?")) {
                await fetch('http://localhost:5000/reset', { method: 'POST' }); 
                document.body.innerHTML = "<h3 style='text-align:center;'>Reset Complete. Restart App.</h3>";
            }
        }
        
        async function shutdownApp() {
            if(confirm("Are you sure you want to quit the tracker?")) {
                await fetch('http://localhost:5000/shutdown', { method: 'POST' });
                document.body.innerHTML = "<h3 style='text-align:center; color:#f44336; margin-top:50px;'>Tracker Stopped.</h3>";
            }
        }

        async function refresh() {
            try {
                const res = await fetch('http://localhost:5000/data');
                const data = await res.json();
                document.getElementById('status-text').innerText = "Online";
                document.getElementById('status-text').style.color = "#4caf50";

                if (data.status === "active") {
                    document.getElementById('game-val').innerText = data.game;
                    document.getElementById('timer-val').innerText = data.duration;
                    if (data.session_unlocks > 0) document.getElementById('unlocks-val').innerText = `(+${data.session_unlocks})`;
                    else document.getElementById('unlocks-val').innerText = "";
                    
                    document.getElementById('game-tools').style.display = "block";

                    // Populate/Refresh dropdown logic
                    if (data.appid !== currentAppID) {
                        currentAppID = data.appid;
                        document.getElementById('name-override').value = data.game;
                        loadedLockedList = false;
                    }

                    if (!loadedLockedList && data.locked_list) {
                        const select = document.getElementById('lock-list');
                        const currentVal = select.value; 
                        select.innerHTML = '<option value="">-- Select Target --</option>';
                        data.locked_list.forEach(a => {
                            const opt = document.createElement('option');
                            opt.value = a.id;
                            opt.innerText = a.name;
                            select.appendChild(opt);
                        });
                        if (currentVal) select.value = currentVal;
                        loadedLockedList = true;
                    }
                } else {
                    document.getElementById('game-val').innerText = "Standby";
                    document.getElementById('timer-val').innerText = "---";
                    document.getElementById('unlocks-val').innerText = "";
                    document.getElementById('game-tools').style.display = "none";
                    currentAppID = null;
                }
            } catch (e) {
                document.getElementById('status-text').innerText = "Offline";
                document.getElementById('status-text').style.color = "#f44336";
            }
        }
        
        setInterval(refresh, 2000);
        refresh();
    </script>
</body>
</html>